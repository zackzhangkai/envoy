<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="835" height="678"><source><![CDATA[participant Envoy as C
participant Management Server as S

C->S: {resource_names={A}}
S->C: {resources={A}, version=1, nonce=1}
C->S: {resource_names={A}, version=1, nonce=1 (this is an ACK)}
Note over C: adding subscription\nto B
C->S: {resource_names={A, B}, version=1, nonce=1}
Note over S: sends B, but system version\ndoes not change because\nserver has not gotten a\nnew config
S->C: {resources={B}, version=1, nonce=2}
Note over C: intending to NACK B
C->S: {resource_names={A, B}, version=1, nonce=2, error_detail="B is invalid"}
Note over S: needs to look at error_detail\nto detect NACK instead of\n using version and nonce
]]></source><desc style="-webkit-tap-highlight-color:transparent">Created with RaphaÃ«l 2.2.0</desc><defs style="-webkit-tap-highlight-color:transparent"><path id="raphael-marker-block" stroke-linecap="round" d="M5,0 0,2.5 5,5z" style="-webkit-tap-highlight-color:transparent"/><marker id="raphael-marker-endblock55-objtaa90" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5" style="-webkit-tap-highlight-color:transparent"><use fill="#000" stroke="none" stroke-width="1" transform="rotate(180 2.5 2.5) scale(1,1)" xlink:href="#raphael-marker-block" style="-webkit-tap-highlight-color:transparent"/></marker><marker id="raphael-marker-endblock55-objkts7d" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5" style="-webkit-tap-highlight-color:transparent"><use fill="#000" stroke="none" stroke-width="1" transform="rotate(180 2.5 2.5) scale(1,1)" xlink:href="#raphael-marker-block" style="-webkit-tap-highlight-color:transparent"/></marker><marker id="raphael-marker-endblock55-obj1uixv" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5" style="-webkit-tap-highlight-color:transparent"><use fill="#000" stroke="none" stroke-width="1" transform="rotate(180 2.5 2.5) scale(1,1)" xlink:href="#raphael-marker-block" style="-webkit-tap-highlight-color:transparent"/></marker><marker id="raphael-marker-endblock55-objzekzs" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5" style="-webkit-tap-highlight-color:transparent"><use fill="#000" stroke="none" stroke-width="1" transform="rotate(180 2.5 2.5) scale(1,1)" xlink:href="#raphael-marker-block" style="-webkit-tap-highlight-color:transparent"/></marker><marker id="raphael-marker-endblock55-objd0fxf" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5" style="-webkit-tap-highlight-color:transparent"><use fill="#000" stroke="none" stroke-width="1" transform="rotate(180 2.5 2.5) scale(1,1)" xlink:href="#raphael-marker-block" style="-webkit-tap-highlight-color:transparent"/></marker><marker id="raphael-marker-endblock55-obj3d7fg" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5" style="-webkit-tap-highlight-color:transparent"><use fill="#000" stroke="none" stroke-width="1" transform="rotate(180 2.5 2.5) scale(1,1)" xlink:href="#raphael-marker-block" style="-webkit-tap-highlight-color:transparent"/></marker></defs><rect width="62.422" height="38.594" x="55.867" y="20" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="42.422" height="18.594" x="66.016" y="30" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="87.078" y="39.297" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">Envoy</tspan></text><rect width="62.422" height="38.594" x="55.867" y="619.703" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="42.422" height="18.594" x="66.016" y="629.703" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="87.078" y="639" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">Envoy</tspan></text><path fill="none" stroke="#000" stroke-width="2" d="M87.078125,58.59375L87.078125,619.703125" style="-webkit-tap-highlight-color:transparent"/><rect width="163.484" height="38.594" x="527.586" y="20" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="143.484" height="18.594" x="537.734" y="30" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="609.328" y="39.297" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">Management Server</tspan></text><rect width="163.484" height="38.594" x="527.586" y="619.703" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="143.484" height="18.594" x="537.734" y="629.703" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="609.328" y="639" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">Management Server</tspan></text><path fill="none" stroke="#000" stroke-width="2" d="M609.328125,58.59375L609.328125,619.703125" style="-webkit-tap-highlight-color:transparent"/><rect width="158.375" height="18.594" x="269.016" y="74.297" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="348.203" y="83.594" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">{resource_names={A}}</tspan></text><path fill="none" stroke="#000" stroke-dasharray="none" stroke-width="2" marker-end="url(#raphael-marker-endblock55-objtaa90)" d="M87.078125,97.1875C87.078125,97.1875,550.880707025528,97.1875,604.3267076886259,97.1875" style="-webkit-tap-highlight-color:transparent"/><rect width="256.094" height="18.594" x="220.156" y="112.891" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="348.203" y="122.188" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">{resources={A}, version=1, nonce=1}</tspan></text><path fill="none" stroke="#000" stroke-dasharray="none" stroke-width="2" marker-end="url(#raphael-marker-endblock55-objkts7d)" d="M609.328125,135.78125C609.328125,135.78125,145.52554297447205,135.78125,92.0795423113741,135.78125" style="-webkit-tap-highlight-color:transparent"/><rect width="416.688" height="18.594" x="139.859" y="151.484" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="348.203" y="160.781" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">{resource_names={A}, version=1, nonce=1 (this is an ACK)}</tspan></text><path fill="none" stroke="#000" stroke-dasharray="none" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj1uixv)" d="M87.078125,174.375C87.078125,174.375,550.880707025528,174.375,604.3267076886259,174.375" style="-webkit-tap-highlight-color:transparent"/><rect width="150.375" height="47.781" x="11.891" y="194.375" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="140.375" height="37.781" x="16.891" y="199.375" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="87.078" y="218.266" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="-4.602" style="-webkit-tap-highlight-color:transparent">adding subscription</tspan><tspan x="87.078" dy="19.2" style="-webkit-tap-highlight-color:transparent">to B</tspan></text><rect width="320.375" height="18.594" x="188.016" y="257.859" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="348.203" y="267.156" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">{resource_names={A, B}, version=1, nonce=1}</tspan></text><path fill="none" stroke="#000" stroke-dasharray="none" stroke-width="2" marker-end="url(#raphael-marker-endblock55-objzekzs)" d="M87.078125,280.75C87.078125,280.75,550.880707025528,280.75,604.3267076886259,280.75" style="-webkit-tap-highlight-color:transparent"/><rect width="208.156" height="86.188" x="505.25" y="300.75" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="198.156" height="76.188" x="510.25" y="305.75" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="609.328" y="343.844" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="-23.797" style="-webkit-tap-highlight-color:transparent">sends B, but system version</tspan><tspan x="609.328" dy="19.2" style="-webkit-tap-highlight-color:transparent">does not change because</tspan><tspan x="609.328" dy="19.2" style="-webkit-tap-highlight-color:transparent">server has not gotten a</tspan><tspan x="609.328" dy="19.2" style="-webkit-tap-highlight-color:transparent">new config</tspan></text><rect width="255.594" height="18.594" x="220.406" y="402.641" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="348.203" y="411.938" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">{resources={B}, version=1, nonce=2}</tspan></text><path fill="none" stroke="#000" stroke-dasharray="none" stroke-width="2" marker-end="url(#raphael-marker-endblock55-objd0fxf)" d="M609.328125,425.53125C609.328125,425.53125,145.52554297447205,425.53125,92.0795423113741,425.53125" style="-webkit-tap-highlight-color:transparent"/><rect width="154.156" height="28.594" x="10" y="445.531" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="144.156" height="18.594" x="15" y="450.531" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="87.078" y="459.828" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">intending to NACK B</tspan></text><rect width="502.25" height="18.594" x="97.078" y="489.828" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="348.203" y="499.125" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="5" style="-webkit-tap-highlight-color:transparent">{resource_names={A, B}, version=1, nonce=2, error_detail=&quot;B is invalid&quot;}</tspan></text><path fill="none" stroke="#000" stroke-dasharray="none" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj3d7fg)" d="M87.078125,512.71875C87.078125,512.71875,550.880707025528,512.71875,604.3267076886259,512.71875" style="-webkit-tap-highlight-color:transparent"/><rect width="207.125" height="66.984" x="505.766" y="532.719" fill="none" stroke="#000" stroke-width="2" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><rect width="197.125" height="56.984" x="510.766" y="537.719" fill="#fff" stroke="none" rx="0" ry="0" style="-webkit-tap-highlight-color:transparent"/><text x="609.328" y="566.211" fill="#000" stroke="none" font-family="Roboto" font-size="16" text-anchor="middle" style="-webkit-tap-highlight-color:transparent;text-anchor:middle;font-family:Roboto;font-size:16px"><tspan dy="-14.203" style="-webkit-tap-highlight-color:transparent">needs to look at error_detail</tspan><tspan x="609.328" dy="19.2" style="-webkit-tap-highlight-color:transparent">to detect NACK instead of</tspan><tspan x="609.328" dy="19.2" style="-webkit-tap-highlight-color:transparent"> using version and nonce</tspan></text></svg>